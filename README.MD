# Berkut Security Search

Berkut Security Search — это веб-приложение для проверки поисковых запросов на соответствие базе данных запрещённых материалов, обеспечивающее соблюдение правил контента. Приложение предоставляет удобный интерфейс для ввода запросов, отображения прогресса проверки, управления избранными сайтами (плитками), настройки базы данных, просмотра информации о подключении и работы через системный трей. Поддерживает полнотекстовый поиск (FTS5) и векторный семантический поиск.

Этот проект распространяется под лицензией [Mozilla Public License 2.0](https://mozilla.org/MPL/2.0/).

## Возможности
- **Проверка запросов**: Проверяет запросы на наличие запрещённых материалов с использованием FTS5 или векторного поиска, минимизируя ложные срабатывания.
- **Прогресс в реальном времени**: Отображает индикатор выполнения проверки через Server-Sent Events (SSE).
- **Интеграция с поисковыми системами**: Перенаправляет безопасные запросы в Google, Yandex или DuckDuckGo одним кликом.
- **Избранные сайты (плитки)**: Позволяет добавлять, редактировать, удалять, импортировать и экспортировать избранные сайты в формате JSON.
- **Информация о подключении**: Отображает IP-адрес, страну, город (если доступно) и интерактивную карту (с использованием Folium) для проверки защищённости подключения.
- **Настройки базы данных**: Поддерживает выбор источника данных (локальный TXT, локальный CSV, удалённый CSV с сайта Минюста).
- **Очистка истории**: Возможность очистки истории поисковых запросов через интерфейс настроек.
- **Системный трей**: Поддержка работы приложения через системный трей с иконкой и меню для быстрого доступа или выхода.
- **Улучшенный интерфейс**: Адаптивный дизайн с тёмной темой, кнопками вместо выпадающих списков, обновлёнными цветами (заголовок: `#e5e7eb`, безопасный запрос: `#22c55e`, кнопки: `#4b5563` с hover `#374151`) и favicon (лупа).
- **Оптимизированный поиск**: Исправлены ошибки чтения данных, улучшена точность поиска в базе.

## Установка

### Требования
- Python 3.8 или выше
- SQLite
- Python-библиотеки (в `requirements.txt`):
  - `flask`
  - `sentence-transformers`
  - `pandas`
  - `numpy`
  - `requests`
  - `folium`
  - `pystray`
  - `pillow`

### Настройка
1. **Клонирование репозитория**:
   ```bash
   git clone https://github.com/berkutsolutions/berkut-security-search.git
   cd berkut-security-search
   ```

2. **Установка зависимостей**:
   ```bash
   pip install -r requirements.txt
   ```

3. **Подготовка базы данных**:
   - Поместите данные о запрещённых материалах в `fs_em.csv` (формат: `№`, `Дата`, `Материал`) или `fs_em.txt` (разделение строкой "Экстремистский материал №").
   - Для удалённого CSV с сайта Минюста настройка не требуется.
   - Инициализируйте базу данных:
     ```bash
     python database.py
     ```
     Это создаст `restricted.db` с данными.

4. **Запуск приложения**:
   - Для полнотекстового поиска с системным треем:
     ```bash
     python run.py
     ```
   - Для векторного поиска с системным треем:
     ```bash
     python tray_app.py
     ```
   - Для векторного поиска без трея:
     ```bash
     python app.py
     ```

5. **Доступ к приложению**:
   - Откройте `http://127.0.0.1:5000` в браузере или используйте системный трей для открытия.

### Структура файлов
- `run.py`: Основной скрипт для полнотекстового поиска (FTS5) с поддержкой системного трея и геолокации.
- `tray_app.py`: Скрипт для векторного семантического поиска с поддержкой системного трея.
- `app.py`: Скрипт для векторного семантического поиска без системного трея.
- `database.py`: Инициализация и обновление базы SQLite из CSV, TXT или удалённого источника.
- `settings.py`: Управление настройками базы данных (источник данных, путь к файлу).
- `index.html`: Шаблон интерфейса с Tailwind CSS и шрифтом Inter.
- `fs_em.csv` / `fs_em.txt`: Входные файлы данных (не включены).
- `restricted.db`: База данных SQLite.
- `tiles.json`: Файл для хранения избранных сайтов.
- `settings.json`: Файл настроек базы данных.
- `db_hash.json`: Файл для хранения хэш-суммы базы данных.
- `icon.png`: Иконка для системного трея (необязательно, создаётся пустая при отсутствии).
- `requirements.txt`: Список зависимостей.

## Использование
1. Запустите приложение (`run.py` или `tray_app.py`) и откройте `http://127.0.0.1:5000` или используйте системный трей (пункт "Открыть").
2. **Управление плитками**:
   - Добавляйте сайты через кнопку "Добавить сайт".
   - Редактируйте или удаляйте плитки через контекстное меню (ПКМ).
   - Импортируйте/экспортируйте плитки через кнопки "Импорт плиток" и "Экспорт плиток".
3. **Поиск**:
   - Введите запрос и нажмите "Поиск".
   - Во время проверки отображается прогресс.
   - Безопасные запросы показывают сообщение "Запрос безопасен!" с иконками Google, Yandex, DuckDuckGo.
   - Запрещённые запросы отображают кнопки с ID материалов, открывающиеся в модальном окне.
4. **Настройки**:
   - Выберите источник базы данных (TXT, CSV, удалённый CSV).
   - Очистите историю запросов.
5. **Информация о подключении**:
   - Просмотрите IP, страну, город и карту в правой колонке.
6. **Системный трей**:
   - Используйте меню трея для открытия приложения или выхода.

## Настройка
- **Путь к базе данных**: Измените пути в `settings.json` или через интерфейс настроек.
- **Порог сходства**: Настройте в `app.py` или `tray_app.py` порог векторного поиска (по умолчанию: `0.7`).
- **Порт и хост**: Измените `app.run(host='127.0.0.1', port=5000)` в `run.py`, `app.py` или `tray_app.py` при необходимости.
- **Удалённый CSV**: Убедитесь, что интернет-соединение доступно для загрузки данных с сайта Минюста.
- **Иконка трея**: Поместите `icon.png` в папку проекта для корректного отображения в системном трее.

## Лицензия
Распространяется под Mozilla Public License 2.0. Подробности: https://mozilla.org/MPL/2.0/.

## Контакты
Для вопросов создайте issue на GitHub: [https://github.com/berkutsolutions/berkut-security-search](https://github.com/berkutsolutions/berkut-security-search).
